<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Infiltré — Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/animations.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            neon: { green: '#00ff88', pink: '#ff0080', cyan: '#00d4ff', amber: '#ffb800' }
          },
          fontFamily: { display: ['Orbitron', 'sans-serif'], body: ['Outfit', 'system-ui', 'sans-serif'] }
        }
      }
    }
  </script>
  <style> body { background: #050508; } </style>
</head>
<body class="min-h-screen text-gray-100 p-4 sm:p-6 md:p-8 font-body antialiased safe-top safe-bottom">
  <div id="app" class="max-w-4xl mx-auto w-full box-border">
    <h1 class="font-display text-2xl sm:text-3xl font-bold text-gradient-hero mb-1">Infiltré — Maître du jeu</h1>
    <p class="text-gray-500 text-xs sm:text-sm mb-6 sm:mb-8">Panneau d'administration (à garder discret)</p>

    <section class="mb-6 sm:mb-8">
      <h2 class="section-title">Joueurs connectés</h2>
      <ul class="space-y-2">
        <li
          v-for="p in players"
          :key="p.id"
          class="glass-card flex items-center justify-between p-3 sm:p-4 rounded-lg sm:rounded-xl gap-2"
        >
          <span class="font-medium text-white text-sm sm:text-base truncate min-w-0">{{ p.name }}</span>
          <span v-if="gameState.agentId === p.id" class="text-neon-green font-display text-xs sm:text-sm font-semibold uppercase tracking-wider shrink-0">Agent</span>
        </li>
      </ul>
      <p v-if="players.length === 0" class="text-gray-500 text-sm">Aucun joueur connecté.</p>
    </section>

    <section v-if="gameState.agentId" class="glass-card mb-6 sm:mb-8 p-4 sm:p-5 rounded-lg sm:rounded-xl border border-neon-cyan/20">
      <h2 class="section-title section-title-green mb-2">Mission en cours</h2>
      <p v-if="gameState.missionCategory" class="text-neon-amber text-sm font-medium mb-1">{{ gameState.missionCategory }}</p>
      <p class="text-gray-300 text-base sm:text-lg break-words">{{ gameState.mission || '—' }}</p>
      <p v-if="gameState.targetName" class="text-sm text-gray-500 mt-2">Cible : {{ gameState.targetName }}</p>
    </section>

    <section class="space-y-4">
      <template v-if="gameState.state === 'IDLE'">
        <p class="text-gray-400 text-sm sm:text-base mb-4">Un agent sera désigné au hasard parmi les joueurs connectés à chaque manche.</p>
        <div class="flex flex-col sm:flex-row flex-wrap gap-3">
          <button
            @click="launchWithRandomAgent()"
            :disabled="players.length === 0"
            class="btn-glow-green w-full sm:w-auto px-6 py-3 rounded-xl font-display text-sm sm:text-base disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Lancer la partie
          </button>
          <button
            @click="resetGame()"
            class="w-full sm:w-auto px-5 py-2.5 rounded-xl bg-white/10 text-gray-300 border border-white/20 hover:bg-white/20 hover:border-neon-cyan/40 transition font-medium text-sm sm:text-base"
          >
            Réinitialiser la manche
          </button>
          <button
            @click="confirmResetAll()"
            class="w-full sm:w-auto px-5 py-2.5 rounded-xl bg-red-500/20 text-red-300 border border-red-500/50 hover:bg-red-500/30 transition font-medium text-sm sm:text-base"
          >
            Tout réinitialiser (partie + scores)
          </button>
        </div>
      </template>

      <template v-else-if="gameState.state === 'INFILTRATION'">
        <p class="text-gray-400 text-sm sm:text-base mb-4">Chrono en cours. Quand tu veux révéler (ou à la fin du temps), clique ci-dessous.</p>
        <div class="flex flex-col sm:flex-row flex-wrap gap-3">
          <button
            @click="triggerReveal()"
            class="btn-glow-pink w-full sm:w-auto px-6 py-3 rounded-xl font-display text-sm sm:text-base"
          >
            Déclencher la RÉVÉLATION
          </button>
          <button
            @click="pauseGame()"
            class="w-full sm:w-auto px-6 py-3 rounded-xl bg-amber-500/90 text-black font-display font-semibold text-sm sm:text-base hover:bg-amber-400 shadow-[0_0_30px_rgba(245,158,11,0.3)] transition"
          >
            Mettre en pause
          </button>
        </div>
      </template>

      <template v-else-if="gameState.state === 'PAUSED'">
        <p class="text-gray-400 text-sm sm:text-base mb-4">La partie est en pause. Le chrono reprendra quand tu cliqueras sur Reprendre.</p>
        <button
          @click="resumeGame()"
          class="btn-glow-green w-full sm:w-auto px-6 py-3 rounded-xl font-display text-sm sm:text-base"
        >
          Reprendre
        </button>
      </template>

      <template v-else-if="gameState.state === 'REVEAL'">
        <p class="text-gray-400 text-sm sm:text-base mb-4">La mission est terminée. L'agent se dénonce à l'oral. Valide ci-dessous.</p>
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
          <button
            @click="resolve(true)"
            class="btn-glow-green w-full sm:flex-1 px-6 py-3 rounded-xl font-display text-sm sm:text-base"
          >
            Succès
          </button>
          <button
            @click="resolve(false)"
            class="btn-glow-pink w-full sm:flex-1 px-6 py-3 rounded-xl font-display text-sm sm:text-base"
          >
            Échec
          </button>
        </div>
      </template>

      <template v-else-if="gameState.state === 'RESOLUTION'">
        <p class="text-gray-400 text-sm sm:text-base mb-4">L'agent a-t-il réussi sa mission ?</p>
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
          <button
            @click="resolve(true)"
            class="btn-glow-green w-full sm:flex-1 px-6 py-3 rounded-xl font-display text-sm sm:text-base"
          >
            Succès
          </button>
          <button
            @click="resolve(false)"
            class="btn-glow-pink w-full sm:flex-1 px-6 py-3 rounded-xl font-display text-sm sm:text-base"
          >
            Échec
          </button>
        </div>
      </template>
    </section>

    <!-- Modal Tout réinitialiser -->
    <div
      v-if="showResetAllModal"
      class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 bg-black/80 backdrop-blur-sm safe-bottom overflow-y-auto"
      @click.self="showResetAllModal = false"
    >
      <div class="glass-card w-full sm:max-w-md p-4 sm:p-6 rounded-t-2xl sm:rounded-2xl border-2 border-red-500/50 shadow-[0_0_60px_rgba(239,68,68,0.2)]">
        <h3 class="font-display text-lg sm:text-xl font-bold text-red-400 mb-3 sm:mb-4">Tout réinitialiser ?</h3>
        <p class="text-gray-400 text-xs sm:text-sm mb-4 sm:mb-6">La partie repassera en attente et tous les scores seront remis à zéro. Les joueurs connectés restent listés.</p>
        <div class="flex flex-col-reverse sm:flex-row gap-3">
          <button
            @click="showResetAllModal = false"
            class="flex-1 py-2.5 rounded-xl bg-white/10 text-gray-300 border border-white/20 hover:bg-white/20 transition font-medium text-sm sm:text-base"
          >
            Annuler
          </button>
          <button
            @click="resetGameAndScores(); showResetAllModal = false"
            class="flex-1 py-2.5 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-400 transition shadow-[0_0_20px_rgba(239,68,68,0.3)] text-sm sm:text-base"
          >
            Oui, tout réinitialiser
          </button>
        </div>
      </div>
    </div>

    <div class="mt-8 sm:mt-12 pt-6 sm:pt-8 border-t border-white/10 text-xs sm:text-sm text-gray-500 flex flex-wrap gap-x-2 gap-y-1 safe-bottom">
      <a href="index.html" class="text-neon-cyan hover:drop-shadow-[0_0_8px_rgba(0,212,255,0.5)] transition">Vue Joueur</a>
      <span>·</span>
      <a href="tv.html" class="text-neon-cyan hover:drop-shadow-[0_0_8px_rgba(0,212,255,0.5)] transition">Vue TV</a>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/app.js"></script>
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          players: [],
          gameState: {},
          showResetAllModal: false
        };
      },
      mounted() {
        InfiltreGame.onPlayers((list) => {
          this.players = list;
        });
        InfiltreGame.onGameState((state) => {
          this.gameState = typeof state === 'object' && state !== null ? { ...state } : {};
        });
      },
      methods: {
        async launchWithRandomAgent() {
          if (!this.players.length) return;
          const p = this.players[Math.floor(Math.random() * this.players.length)];
          await InfiltreGame.startInfiltration(p.id, p.name, this.players);
        },
        triggerReveal() {
          InfiltreGame.triggerReveal();
        },
        async resolve(success) {
          const agentId = this.gameState.agentId;
          const agentName = this.gameState.agentName;
          const leaderboard = this.gameState.leaderboard || {};
          if (!agentId && !agentName) return;
          await InfiltreGame.setResolution(success);
          await InfiltreGame.applyScoresAndReset(agentId, success, leaderboard, agentName, true);
        },
        resetGame() {
          InfiltreGame.resetGame();
        },
        confirmResetAll() {
          this.showResetAllModal = true;
        },
        resetGameAndScores() {
          InfiltreGame.resetGameAndScores();
        },
        pauseGame() {
          InfiltreGame.pauseGame();
        },
        resumeGame() {
          InfiltreGame.resumeGame();
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
