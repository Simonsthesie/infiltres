<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Infiltré — Joueur</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/animations.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            neon: { green: '#00ff88', pink: '#ff0080', cyan: '#00d4ff' }
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0a0a0f; }
  </style>
</head>
<body class="min-h-screen bg-[#0a0a0f] text-gray-100 font-sans">
  <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4 relative">
    <!-- Écran de connexion -->
    <div v-show="!playerId" class="w-full max-w-sm text-center">
      <h1 class="text-2xl font-bold text-neon-green mb-2">Infiltré</h1>
      <p class="text-gray-400 text-sm mb-6">Entre ton pseudo pour rejoindre la partie. Tu peux rejoindre ou quitter à tout moment, la partie continue et ton score est conservé.</p>
      <input
        v-model="playerName"
        type="text"
        placeholder="Ton pseudo"
        maxlength="30"
        class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-600 text-white placeholder-gray-500 focus:border-neon-green focus:ring-1 focus:ring-neon-green outline-none mb-4"
        @keyup.enter="join()"
      />
      <button
        @click="join()"
        :disabled="!playerName.trim()"
        class="w-full py-3 rounded-lg bg-neon-green text-black font-semibold hover:bg-emerald-400 disabled:opacity-50 disabled:cursor-not-allowed transition"
      >
        Rejoindre
      </button>
    </div>

    <!-- Écran joueur connecté -->
    <template v-if="playerId">
      <p class="absolute top-4 left-4 right-4 text-center text-gray-500 text-sm">
        Je suis <span class="text-neon-cyan font-medium">{{ displayName }}</span>
      </p>
      <!-- Agent : mission secrète -->
      <div v-if="isAgent" class="w-full max-w-lg text-center space-y-6">
        <p class="text-neon-green text-sm font-medium">Tu es l'agent</p>
        <div class="p-6 rounded-xl bg-gray-800/80 border border-neon-green/50 animate-pulse-glow">
          <p class="text-lg font-medium text-neon-green mb-2">Ta mission secrète</p>
          <p class="text-xl text-white">{{ gameState.mission || '—' }}</p>
        </div>
        <p class="text-gray-500 text-sm">Ne te fais pas repérer. La révélation aura lieu à l'écran.</p>
      </div>

      <!-- Non-agent : écran d'attente -->
      <div v-else class="w-full max-w-lg text-center space-y-6">
        <p class="text-neon-cyan text-sm">Tu es dans la partie</p>
        <div class="p-6 rounded-xl bg-gray-800/50 border border-gray-600">
          <p class="text-gray-400">{{ gameState.stateMessage || 'En attente...' }}</p>
          <p class="text-gray-500 text-sm mt-2">Observe les autres. Qui est l'agent ?</p>
        </div>
        <div v-if="canGrill" class="space-y-2">
          <button
            @click="showGrillModal = true"
            :disabled="otherPlayers.length === 0"
            class="px-6 py-3 rounded-lg bg-neon-pink/20 text-neon-pink border border-neon-pink font-semibold hover:bg-neon-pink/30 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            J'ai grillé...
          </button>
          <p v-if="alreadyGrillWinner" class="text-xs text-gray-500">Quelqu'un a déjà trouvé l'agent ce round.</p>
        </div>
      </div>

      <!-- Modal J'ai grillé -->
      <div
        v-if="showGrillModal"
        class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70"
        @click.self="showGrillModal = false"
      >
        <div class="max-w-sm w-full p-6 rounded-xl bg-gray-900 border border-neon-pink shadow-2xl">
          <h3 class="text-lg font-bold text-neon-pink mb-4">Qui est l'agent ?</h3>
          <select
            v-model="grillSelectedId"
            class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-600 text-white mb-4"
          >
            <option value="">Choisir un joueur</option>
            <option v-for="p in otherPlayers" :key="p.id" :value="p.id">{{ p.name }}</option>
          </select>
          <p v-if="grillFeedback" class="text-sm mb-4" :class="grillFeedback.ok ? 'text-neon-green' : 'text-red-400'">{{ grillFeedback.message }}</p>
          <div class="flex gap-3">
            <button
              @click="confirmGrill()"
              :disabled="!grillSelectedId"
              class="flex-1 py-2 rounded-lg bg-neon-pink text-white font-semibold disabled:opacity-50"
            >
              Valider
            </button>
            <button
              @click="showGrillModal = false; grillFeedback = null"
              class="flex-1 py-2 rounded-lg bg-gray-700 text-gray-300"
            >
              Annuler
            </button>
          </div>
        </div>
      </div>

      <button
        @click="leave()"
        class="mt-8 text-sm text-gray-500 hover:text-red-400 transition"
      >
        Quitter la partie
      </button>
      <p class="mt-2 text-xs text-gray-600">Tu peux revenir plus tard avec le même pseudo, ton score restera.</p>
    </template>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/app.js"></script>
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          playerName: '',
          playerId: null,
          gameState: {},
          players: [],
          showGrillModal: false,
          grillSelectedId: '',
          grillFeedback: null
        };
      },
      computed: {
        isAgent() {
          return this.playerId && this.gameState.agentId === this.playerId;
        },
        canGrill() {
          const s = this.gameState.state;
          return (s === 'INFILTRATION' || s === 'PAUSED') && !this.isAgent && !this.gameState.grillWinner;
        },
        otherPlayers() {
          if (!this.players.length || !this.playerId) return [];
          return this.players.filter(p => p.id !== this.playerId);
        },
        displayName() {
          if (this.playerName) return this.playerName;
          const me = this.players.find(p => p.id === this.playerId);
          return (me && me.name) || '...';
        },
        alreadyGrillWinner() {
          return this.gameState.grillWinner && this.gameState.grillWinner !== this.playerId;
        }
      },
      mounted() {
        this.playerId = sessionStorage.getItem('infiltre_player_id');
        this.playerName = sessionStorage.getItem('infiltre_player_name') || '';
        if (this.playerId) {
          InfiltreGame.onGameState((state) => {
            this.gameState = typeof state === 'object' && state !== null ? { ...state } : {};
          });
          InfiltreGame.onPlayers((list) => {
            this.players = list || [];
          });
          this._unsubGame = true;
        }
      },
      beforeUnmount() {
        if (this._unsubGame) this._unsubGame();
      },
      methods: {
        join() {
          const name = this.playerName.trim();
          if (!name) return;
          const id = InfiltreGame.joinGame(name);
          sessionStorage.setItem('infiltre_player_id', id);
          sessionStorage.setItem('infiltre_player_name', name);
          this.playerId = id;
          InfiltreGame.onGameState((state) => {
            this.gameState = typeof state === 'object' && state !== null ? { ...state } : {};
          });
          InfiltreGame.onPlayers((list) => {
            this.players = list || [];
          });
          this._unsubGame = true;
        },
        leave() {
          if (this.playerId) {
            InfiltreGame.leaveGame(this.playerId);
            sessionStorage.removeItem('infiltre_player_id');
            sessionStorage.removeItem('infiltre_player_name');
          }
          if (this._unsubGame) this._unsubGame();
          this.playerId = null;
          this.playerName = '';
          this.gameState = {};
          this.players = [];
        },
        async confirmGrill() {
          if (!this.grillSelectedId || !this.playerId) return;
          const name = this.playerName || sessionStorage.getItem('infiltre_player_name') || '';
          const result = await InfiltreGame.submitGrill(this.playerId, name, this.grillSelectedId);
          if (result.ok) {
            this.grillFeedback = { ok: true, message: 'Bravo ! +2 points.' };
            setTimeout(() => {
              this.showGrillModal = false;
              this.grillFeedback = null;
              this.grillSelectedId = '';
            }, 1500);
          } else if (result.reason === 'wrong') {
            this.grillFeedback = { ok: false, message: 'Faux ! Ce n\'est pas l\'agent. -3 points.' };
          } else if (result.reason === 'already_guessed') {
            this.grillFeedback = { ok: false, message: 'Quelqu\'un a déjà trouvé ce round.' };
          } else {
            this.grillFeedback = { ok: false, message: 'Impossible pour l\'instant.' };
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
