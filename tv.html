<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Infiltr√© ‚Äî Vue TV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/animations.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            neon: { green: '#00ff88', pink: '#ff0080', cyan: '#00d4ff', amber: '#ffb800' }
          },
          fontFamily: { display: ['Orbitron', 'sans-serif'], body: ['Outfit', 'system-ui', 'sans-serif'] }
        }
      }
    }
  </script>
  <style>
    body { background: #050508; }
    .font-mono { font-family: ui-monospace, monospace; }
  </style>
</head>
<body class="min-h-screen text-gray-100 overflow-x-hidden font-body antialiased safe-top safe-bottom">
  <div id="app" class="min-h-screen flex flex-col p-4 sm:p-6 md:p-8 lg:p-10 box-border overflow-x-hidden">
    <header class="flex flex-col sm:flex-row sm:flex-wrap items-center justify-between gap-3 sm:gap-4 mb-6 sm:mb-8">
      <h1 class="font-display text-2xl sm:text-3xl md:text-4xl font-bold text-gradient-hero order-1 sm:order-none">Infiltr√©</h1>
      <p class="text-gray-300 text-sm sm:text-base md:text-lg max-w-2xl text-center sm:text-left order-3 sm:order-2 w-full sm:w-auto sm:max-w-xl">{{ statusMessage }}</p>
      <div class="timer-display font-mono text-2xl sm:text-3xl md:text-5xl tabular-nums order-2 sm:order-3"> {{ formattedTimer }}</div>
    </header>

    <!-- Banni√®re Mission en cours -->
    <section
      v-if="isMissionActive"
      class="banner-mission mb-6 sm:mb-8 p-5 sm:p-6 md:p-8 rounded-xl sm:rounded-2xl text-center"
    >
      <p class="text-neon-green font-display font-bold text-lg sm:text-xl md:text-2xl mb-1 sm:mb-2 uppercase tracking-wider">Mission en cours</p>
      <p class="text-gray-300 text-sm sm:text-base mb-2 sm:mb-3">{{ gameState.stateMessage }}</p>
      <p class="timer-display font-mono text-3xl sm:text-4xl md:text-5xl">{{ formattedTimer }}</p>
    </section>

    <!-- Joueurs connect√©s -->
    <section class="mb-6 sm:mb-8">
      <h2 class="section-title">Joueurs connect√©s ({{ players.length }})</h2>
      <div class="flex flex-wrap gap-2">
        <span
          v-for="p in players"
          :key="p.id"
          class="badge-player px-3 py-1.5 sm:px-4 sm:py-2 rounded-full text-white text-sm sm:text-base font-medium"
        >
          {{ p.name }}
        </span>
      </div>
      <p v-if="players.length === 0" class="text-gray-500 text-sm">Aucun joueur pour l'instant.</p>
    </section>

    <section class="mb-6 sm:mb-8">
      <h2 class="section-title section-title-pink">Classement</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 sm:gap-3">
        <div
          v-for="(entry, index) in leaderboardList"
          :key="entry.name + index"
          class="leaderboard-row flex items-center justify-between p-3 sm:p-4 gap-2"
        >
          <span class="font-semibold text-white text-sm sm:text-base truncate min-w-0">{{ entry.name || 'Joueur' }}</span>
          <div class="flex gap-2 sm:gap-4 text-xs sm:text-sm font-medium shrink-0">
            <span class="text-neon-green">‚úì {{ entry.score || 0 }}</span>
            <span class="text-neon-pink">üç∫ {{ entry.gages || 0 }}</span>
          </div>
        </div>
      </div>
      <p v-if="leaderboardList.length === 0" class="text-gray-500 text-sm">Aucun score pour l'instant.</p>
    </section>

    <!-- Pop-up R√âV√âLATION -->
    <div
      v-show="showRevealPopup"
      class="fixed inset-0 z-50 flex items-center justify-center p-3 sm:p-4 bg-black/85 backdrop-blur-md overflow-y-auto safe-top safe-bottom"
      @click.self="closeRevealPopup"
    >
      <div
        class="reveal-popup glass-card w-full max-w-2xl my-auto p-5 sm:p-8 md:p-12 rounded-xl sm:rounded-2xl border-2 border-neon-green/60 shadow-[0_0_80px_rgba(0,255,136,0.25)]"
        :class="{ 'reveal-trigger': revealTrigger }"
      >
        <p class="text-neon-pink font-display text-xs sm:text-sm uppercase tracking-widest mb-1 sm:mb-2">Temps √©coul√©</p>
        <p class="font-display text-xl sm:text-2xl md:text-3xl font-bold text-neon-green mb-4 sm:mb-6">La mission est termin√©e !</p>
        <p class="text-base sm:text-xl text-white mb-6 sm:mb-8">Que l'agent se d√©nonce !</p>
        <p class="text-gray-400 text-xs sm:text-sm mb-1">L'agent √©tait</p>
        <p class="reveal-agent-name text-lg sm:text-xl font-bold text-neon-cyan mb-3 sm:mb-4 drop-shadow-[0_0_12px_rgba(0,212,255,0.5)] break-words">
          {{ gameState.agentName || '‚Äî' }}
        </p>
        <p class="text-gray-400 text-xs sm:text-sm mb-1">Sa mission √©tait</p>
        <p class="reveal-mission text-base sm:text-lg text-gray-300 leading-relaxed mb-4 sm:mb-6 break-words">
          {{ gameState.mission || '‚Äî' }}
        </p>
        <button
          @click="closeRevealPopup"
          class="w-full sm:w-auto px-6 py-2.5 rounded-xl bg-white/10 text-gray-300 border border-white/20 hover:bg-white/20 hover:border-neon-cyan/50 transition font-medium text-sm sm:text-base"
        >
          Fermer
        </button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/app.js"></script>
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          gameState: {},
          players: [],
          timerInterval: null,
          revealTimeoutInterval: null,
          serverTimeOffset: 0,
          now: Date.now(),
          showRevealPopup: false,
          revealTrigger: false
        };
      },
      computed: {
        statusMessage() {
          const msg = this.gameState.stateMessage;
          if (msg) return msg;
          return this.gameState.state ? 'Chargement...' : 'En attente de la partie...';
        },
        isMissionActive() {
          const s = this.gameState.state;
          return s === InfiltreGame.STATES.INFILTRATION || s === InfiltreGame.STATES.PAUSED;
        },
        leaderboardList() {
          const lb = this.gameState.leaderboard || {};
          const byKey = {};
          for (const p of this.players) {
            const key = (p.name && String(p.name).trim()) || p.id;
            if (!key) continue;
            byKey[key] = { name: p.name || 'Joueur', score: 0, gages: 0 };
          }
          for (const [id, v] of Object.entries(lb)) {
            const key = (v && v.name && String(v.name).trim()) ? String(v.name).trim() : id;
            if (!byKey[key]) byKey[key] = { name: (v && v.name) ? String(v.name).trim() : id, score: 0, gages: 0 };
            byKey[key].score += (v && v.score) || 0;
            byKey[key].gages += (v && v.gages) || 0;
          }
          return Object.values(byKey).sort((a, b) => (b.score || 0) - (a.score || 0));
        },
        formattedTimer() {
          const state = this.gameState.state;
          const remainingSeconds = this.gameState.remainingSeconds;
          if (state === InfiltreGame.STATES.PAUSED && remainingSeconds != null) {
            const m = Math.floor(remainingSeconds / 60);
            const s = Math.floor(remainingSeconds % 60);
            return m + ':' + (s < 10 ? '0' : '') + s;
          }
          if (state !== InfiltreGame.STATES.INFILTRATION) return '--:--';
          const revealAt = this.effectiveRevealAt;
          if (!revealAt) return '--:--';
          const serverNow = this.now + (this.serverTimeOffset || 0);
          const remaining = Math.max(0, Math.floor((revealAt - serverNow) / 1000));
          const m = Math.floor(remaining / 60);
          const s = remaining % 60;
          return m + ':' + (s < 10 ? '0' : '') + s;
        },
        effectiveRevealAt() {
          const g = this.gameState;
          if (g.revealAt != null) return g.revealAt;
          const dur = g.durationSeconds != null ? g.durationSeconds : (g.durationMinutes != null ? g.durationMinutes * 60 : null);
          if (g.startedAt != null && dur != null) return g.startedAt + dur * 1000;
          return null;
        }
      },
      watch: {
        'gameState.state'(newState) {
          if (newState === InfiltreGame.STATES.REVEAL) {
            this.showRevealPopup = true;
            this.revealTrigger = true;
            setTimeout(() => {
              if (typeof confetti === 'function') {
                confetti({ particleCount: 80, spread: 60 });
              }
            }, 400);
          } else {
            this.showRevealPopup = false;
            this.revealTrigger = false;
          }
        }
      },
      mounted() {
        const db = typeof FIREBASE_DB !== 'undefined' ? FIREBASE_DB : (window.FIREBASE_DB);
        if (db && db.ref) {
          db.ref('.info/serverTimeOffset').on('value', (snap) => {
            const v = snap.val();
            this.serverTimeOffset = typeof v === 'number' ? v : 0;
          });
        }
        InfiltreGame.onGameState((state) => {
          this.gameState = typeof state === 'object' && state !== null ? { ...state } : {};
        });
        InfiltreGame.onPlayers((list) => {
          this.players = list || [];
        });
        this.timerInterval = setInterval(() => {
          this.now = Date.now();
          const revealAt = this.effectiveRevealAt;
          const serverNow = this.now + (this.serverTimeOffset || 0);
          if (this.gameState.state === InfiltreGame.STATES.INFILTRATION && revealAt != null && serverNow >= revealAt) {
            InfiltreGame.triggerReveal();
          }
        }, 1000);
        this.revealTimeoutInterval = setInterval(() => {
          InfiltreGame.checkRevealTimeout();
        }, 30000);
      },
      beforeUnmount() {
        if (this.timerInterval) clearInterval(this.timerInterval);
        if (this.revealTimeoutInterval) clearInterval(this.revealTimeoutInterval);
      },
      methods: {
        closeRevealPopup() {
          this.showRevealPopup = false;
          this.revealTrigger = false;
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
